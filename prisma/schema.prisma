generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports    Report[]
  purchases  Purchase[]
  magicLinks MagicLink[]
}

model Report {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Quiz answers (JSON blob)
  quizAnswers Json

  // Computed results
  fitTrack    String   // e.g., "Chrome extension utility"
  winnerId    String   // e.g., "ext-tab-sweeper"
  rankedIdeas Json     // array of { id, name, score, reason }
  fitProfile  Json     // computed fit profile

  // AI-generated content (populated on unlock)
  aiIdeas     Json?    // full AI-generated ideas with details
  aiCost      Float?   // total AI generation cost for tracking

  // Status
  status     ReportStatus @default(PREVIEW)
  unlockedAt DateTime?

  // Regenerations
  regensUsed     Int       @default(0)
  regensMax      Int       @default(5)
  regenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]
}

enum ReportStatus {
  PREVIEW
  UNLOCKED
  EXPIRED
}

model Purchase {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id])
  reportId String
  report   Report @relation(fields: [reportId], references: [id])

  stripeSessionId String  @unique
  stripePaymentId String?
  amount          Int // cents
  credits         Int     @default(1)

  createdAt DateTime @default(now())
}

model MagicLink {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())
}

// Analytics Events - persisted across deploys
model AnalyticsEvent {
  id        String   @id @default(cuid())
  event     String   // event name (view_home, start_quiz, etc.)
  sessionId String   // anonymous session identifier
  build     String   // git SHA of the build

  // Tracking metadata
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?
  referrer    String?
  userAgent   String?

  // Event-specific properties (JSON)
  properties Json?

  // Deduplication: hash of event+sessionId+timestamp(rounded to minute)
  dedupKey  String   @unique

  createdAt DateTime @default(now())

  // Indexes for common queries
  @@index([event])
  @@index([sessionId])
  @@index([createdAt])
  @@index([utmSource])
  @@index([utmMedium])
  @@index([utmCampaign])
  @@index([build])
}

// Stripe webhook idempotency - prevents duplicate processing
model ProcessedStripeEvent {
  id        String   @id // Stripe event ID (evt_xxx)
  mode      String   // 'test' or 'live'
  eventType String   // e.g., 'checkout.session.completed'
  createdAt DateTime @default(now())

  @@index([mode])
}
